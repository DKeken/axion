---
title: "BullMQ Standardization"
description: "–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è BullMQ –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á —Å correlationId –∏ backoff —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏"
order: 7
---

# BullMQ Standardization

Axion Stack –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ —Ä–∞–±–æ—Ç–µ —Å BullMQ –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á (–¥–µ–ø–ª–æ–∏, —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≥–µ–Ω—Ç–æ–≤, SSH –∫–æ–º–∞–Ω–¥—ã).

## üìã –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### Job Payload —Å correlationId

–í—Å–µ job payload –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–æ–≥–∞—â–∞—é—Ç—Å—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏:

```typescript
import {
  enrichJobPayloadWithMetadata,
  getCorrelationIdFromJob,
} from "@axion/nestjs-common";

// –û–±–æ–≥–∞—Ç–∏—Ç—å payload –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
const enrichedPayload = enrichJobPayloadWithMetadata(
  { deploymentId: "deploy-123" },
  metadata
);
// {
//   deploymentId: "deploy-123",
//   correlationId: "req-789",
//   requestId: "req-789",
//   userId: "user-123",
//   projectId: "project-456",
//   timestamp: 1234567890
// }

// –ò–∑–≤–ª–µ—á—å correlationId –∏–∑ job
const job = await queue.getJob(jobId);
const correlationId = getCorrelationIdFromJob(job);
```

### Backoff —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

–ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∑–∞–¥–∞—á:

```typescript
import { BACKOFF_STRATEGIES } from "@axion/nestjs-common";

// Exponential: 1s, 2s, 4s, 8s, 16s, ...
BACKOFF_STRATEGIES.exponential(1000);

// Fixed: 5s, 5s, 5s, ...
BACKOFF_STRATEGIES.fixed(5000);

// Fast: 500ms, 1s, 2s, 4s, ...
BACKOFF_STRATEGIES.fast();

// Slow: 5s, 10s, 20s, 40s, ...
BACKOFF_STRATEGIES.slow();
```

### Job Options Presets

–ì–æ—Ç–æ–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∑–∞–¥–∞—á:

```typescript
import { JOB_OPTIONS_PRESETS } from "@axion/nestjs-common";

// Quick job: 3 attempts, fast backoff, remove on complete
JOB_OPTIONS_PRESETS.quick();

// Standard job: 5 attempts, exponential backoff
JOB_OPTIONS_PRESETS.standard();

// Reliable job: 10 attempts, slow backoff, keep failed jobs
JOB_OPTIONS_PRESETS.reliable();

// Critical job: 20 attempts, keep everything
JOB_OPTIONS_PRESETS.critical();
```

## üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ job —Å metadata

```typescript
import {
  addStandardJobWithMetadata,
  JOB_OPTIONS_PRESETS,
} from "@axion/nestjs-common";

// –í —Å–µ—Ä–≤–∏—Å–µ
const job = await addStandardJobWithMetadata(
  this.deploymentQueue,
  "deploy",
  {
    deploymentId: "deploy-123",
    projectId: "project-456",
  },
  JOB_OPTIONS_PRESETS.standard(),
  data.metadata // RequestMetadata —Å correlationId
);

// Job –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç correlationId –≤ payload
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ job –≤ processor

```typescript
import { Processor } from "@nestjs/bullmq";
import { WorkerHost } from "@nestjs/bullmq";
import { getCorrelationIdFromJob } from "@axion/nestjs-common";
import type { Job } from "bullmq";

@Processor("deployment")
export class DeploymentProcessor extends WorkerHost {
  async process(job: Job<DeploymentJobPayload>): Promise<void> {
    // –ò–∑–≤–ª–µ—á—å correlationId –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    const correlationId = getCorrelationIdFromJob(job);
    this.logger.log(
      `[${correlationId}] Processing deployment ${job.data.deploymentId}`
    );

    // correlationId –¥–æ—Å—Ç—É–ø–µ–Ω –≤ job.data.correlationId
    // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
  }
}
```

## üìù Best Practices

1. **–í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ metadata** - —ç—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –Ω–∞–ª–∏—á–∏–µ correlationId –≤ job
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ presets** - –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∑–∞–¥–∞—á –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `JOB_OPTIONS_PRESETS`
3. **–õ–æ–≥–∏—Ä—É–π—Ç–µ correlationId** - –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ –∑–∞–¥–∞—á —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥–∏
4. **–í—ã–±–∏—Ä–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é** - quick –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–¥–∞—á, reliable –¥–ª—è –≤–∞–∂–Ω—ã—Ö

## üîç –ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–≥–æ flow

```typescript
// 1. –°–æ–∑–¥–∞–Ω–∏–µ job —Å metadata
async deployProject(data: DeployProjectRequest) {
  const deployment = await this.repository.create({...});

  const job = await addStandardJobWithMetadata(
    this.deploymentQueue,
    "deploy",
    { deploymentId: deployment.id },
    JOB_OPTIONS_PRESETS.standard(),
    data.metadata // correlationId –∏–∑ HTTP –∑–∞–ø—Ä–æ—Å–∞
  );

  return createSuccessResponse({ deployment, jobId: job.id });
}

// 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ job
@Processor("deployment")
export class DeploymentProcessor extends WorkerHost {
  async process(job: Job<DeploymentJobPayload>): Promise<void> {
    const correlationId = getCorrelationIdFromJob(job);
    this.logger.log(`[${correlationId}] Starting deployment`);

    try {
      // –í—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–ø–ª–æ–π
      await this.deploy(job.data);
      this.logger.log(`[${correlationId}] Deployment completed`);
    } catch (error) {
      this.logger.error(`[${correlationId}] Deployment failed`, error);
      throw error; // BullMQ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç retry
    }
  }
}
```

### Queue Configuration

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ rate limiting –∏ concurrency –¥–ª—è –æ—á–µ—Ä–µ–¥–µ–π:

```typescript
import {
  createQueueOptions,
  createWorkerOptions,
  QUEUE_CONFIGS,
  parseRateLimiterFromEnv,
} from "@axion/nestjs-common";

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
const queueOptions = createQueueOptions(QUEUE_CONFIGS.highVolume());
// {
//   limiter: { max: 100, duration: 60000 },
//   lockDuration: 60000,
//   maxStalledCount: 3,
//   stalledInterval: 30000
// }

// –ò–ª–∏ –∫–∞—Å—Ç–æ–º–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
const customOptions = createQueueOptions({
  limiter: {
    max: 10,
    duration: 60000, // 10 jobs per minute
  },
  lockDuration: 30000,
  concurrency: 5,
});

// –î–ª—è Worker
const workerOptions = createWorkerOptions({
  concurrency: 3,
  lockDuration: 60000,
  maxStalledCount: 2,
});

// –ò–∑ environment –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
const limiter = parseRateLimiterFromEnv(process.env.DEPLOYMENT_QUEUE_LIMITER); // Format: "10:60" = 10 jobs per 60 seconds
```

### Stalled Jobs Handling

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–∏—Å—à–∏—Ö jobs:

```typescript
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ stalled jobs
const queueOptions = createQueueOptions({
  lockDuration: 30000, // Job —Å—á–∏—Ç–∞–µ—Ç—Å—è stalled —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
  maxStalledCount: 3, // –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
  stalledInterval: 30000, // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
});
```

## üîó –°–º. —Ç–∞–∫–∂–µ

- [Kafka Headers](./KAFKA_HEADERS.mdx) - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è Kafka headers
- [API Reference](./API_REFERENCE.mdx) - HTTP API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [Architecture](./ARCHITECTURE.mdx) - –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã
