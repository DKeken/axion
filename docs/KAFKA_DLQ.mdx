---
title: "Kafka Dead Letter Queue (DLQ)"
description: "–°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ—É–¥–∞—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ Dead Letter Queue"
order: 8
---

# Kafka Dead Letter Queue (DLQ)

Axion Stack –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é Dead Letter Queue –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ø—ã—Ç–æ–∫.

## üìã –û–±–∑–æ—Ä

DLQ (Dead Letter Queue) - —ç—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ—Å–ª–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ø—ã—Ç–æ–∫. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç:

- –ò–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–æ–∫
- –ü–æ–≤—Ç–æ—Ä–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ —Ü–∏–∫–ª—ã retry

## üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DLQ Interceptor

```typescript
import { KafkaDLQInterceptor } from "@axion/nestjs-common";
import { GRAPH_SERVICE_NAME } from "@axion/contracts";

@Module({
  providers: [
    {
      provide: APP_INTERCEPTOR,
      useFactory: (dlqClient: ClientKafka) =>
        new KafkaDLQInterceptor({
          serviceName: GRAPH_SERVICE_NAME,
          maxRetries: 3,
          useCommonDLQ: false, // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å service-specific DLQ
          dlqClient, // Optional: –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ DLQ topic
          enabled: true,
        }),
      inject: [GRAPH_SERVICE_NAME], // Inject Kafka client
    },
  ],
})
export class AppModule {}
```

### DLQ Event Envelope

–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ DLQ –∏–º–µ—é—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç envelope:

```typescript
interface DLQEventEnvelope {
  originalTopic: string; // –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–æ–ø–∏–∫
  originalKey?: string; // –ò—Å—Ö–æ–¥–Ω—ã–π –∫–ª—é—á
  originalHeaders: Record<string, string>; // –ò—Å—Ö–æ–¥–Ω—ã–µ headers
  originalPayload: unknown; // –ò—Å—Ö–æ–¥–Ω—ã–π payload
  attempt: number; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
  error: {
    message: string;
    stack?: string;
    code?: string;
  };
  dlqTimestamp: number; // –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ DLQ
  serviceName: string; // –°–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ —Å–º–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
  messagePattern?: string; // MessagePattern
  correlationId?: string; // –î–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏
}
```

### –¢–æ–ø–∏–∫–∏ DLQ

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è service-specific DLQ:

- `graph-service-dlq` - –¥–ª—è Graph Service
- `codegen-service-dlq` - –¥–ª—è Codegen Service
- `deployment-service-dlq` - –¥–ª—è Deployment Service

–ò–ª–∏ –æ–±—â–∏–π DLQ (–µ—Å–ª–∏ `useCommonDLQ: true`):

- `axion-dlq` - –æ–±—â–∏–π DLQ –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

## üîÑ Replay –∏–∑ DLQ

### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è replay

```typescript
import { prepareDLQReplay } from "@axion/shared";

const replay = prepareDLQReplay(dlqEnvelope, {
  targetTopic: "original-topic", // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –¥—Ä—É–≥–æ–π —Ç–æ–ø–∏–∫
  newCorrelationId: "new-req-id", // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –Ω–æ–≤—ã–π correlationId
  resetAttempt: true, // –°–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫
  additionalHeaders: {
    "x-replay-reason": "fixed-bug",
  },
});

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
await kafkaClient.emit(replay.topic, replay.payload, {
  key: replay.key,
  headers: replay.headers,
});
```

### –ó–∞—â–∏—Ç–∞ –æ—Ç —Ü–∏–∫–ª–æ–≤

DLQ interceptor –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç replay —Å–æ–æ–±—â–µ–Ω–∏—è, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ —Ü–∏–∫–ª—ã:

```typescript
// –°–æ–æ–±—â–µ–Ω–∏–µ —Å –º–∞—Ä–∫–µ—Ä–æ–º x-dlq-replay –±—É–¥–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω–æ
headers: {
  "x-dlq-replay": "true",
  "x-dlq-original-topic": "original-topic",
  "x-dlq-original-attempt": "3",
}
```

## üìù Best Practices

1. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ maxRetries** - –æ–±—ã—á–Ω–æ 3-5 –ø–æ–ø—ã—Ç–æ–∫ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ service-specific DLQ** - –¥–ª—è –ª—É—á—à–µ–π –∏–∑–æ–ª—è—Ü–∏–∏
3. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ DLQ —Ç–æ–ø–∏–∫–∏** - —Ä–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
4. **–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—à–∏–±–∫–∏** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ envelope –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
5. **Replay —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é** - —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞

## üîç –ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–≥–æ flow

```typescript
// 1. –°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ —Å–µ—Ä–≤–∏—Å
@MessagePattern(GRAPH_SERVICE_PATTERNS.CREATE_PROJECT)
async createProject(@Payload() data: CreateProjectRequest) {
  // –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ
  throw new Error("Database connection failed");
}

// 2. DLQ Interceptor –ª–æ–≤–∏—Ç –æ—à–∏–±–∫—É
// - –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç attempt counter
// - –ï—Å–ª–∏ attempt > maxRetries, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ DLQ

// 3. –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ DLQ
// Topic: graph-service-dlq
// Payload: DLQEventEnvelope —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π

// 4. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É
// - –°–º–æ—Ç—Ä–∏—Ç error.message –∏ error.stack
// - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç originalPayload
// - –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ–±–ª–µ–º—É

// 5. Replay —Å–æ–æ–±—â–µ–Ω–∏—è
const replay = prepareDLQReplay(dlqEnvelope, {
  resetAttempt: true,
});
await kafkaClient.emit(replay.topic, replay.payload, {
  headers: replay.headers,
});
```

## üîó –°–º. —Ç–∞–∫–∂–µ

- [Kafka Headers](./KAFKA_HEADERS.mdx) - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è headers
- [Kafka Integration](./KAFKA_INTEGRATION.md) - –±–∞–∑–æ–≤–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- [Architecture](./ARCHITECTURE.mdx) - –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã
