---
title: "Auth Service"
description: "Сервис аутентификации и валидации сессий"
---

# Auth Service

**Auth Service** отвечает за управление пользователями, аутентификацию и валидацию сессий. Он построен на базе [Better Auth](https://better-auth.com/) и интегрируется с остальной системой через HTTP и Kafka.

## Архитектура

Сервис реализован на **Elysia (Node.js)** для максимальной производительности HTTP-запросов и использует **Better Auth** для управления логикой аутентификации.

### Ключевые компоненты

1.  **HTTP API (Elysia)**:
    - `/api/auth/*`: Стандартные эндпоинты Better Auth (login, register, logout и т.д.).
    - `/api/auth/validate-session`: Специальный эндпоинт для внутренней валидации сессий другими сервисами.

2.  **Kafka Consumer**:
    - Слушает группу `axion-auth-service-group`.
    - Обрабатывает запросы валидации сессий через Kafka (для микросервисного взаимодействия).

3.  **Database**:
    - Использует PostgreSQL (через Drizzle ORM) для хранения пользователей, сессий и аккаунтов.
    - Схема базы данных управляется Better Auth.

## Бизнес-логика

### Аутентификация

- Поддержка Email/Password аутентификации.
- Управление сессиями (создание, продление, удаление).
- Хранение профилей пользователей (имя, email, аватар).

### Валидация сессий

Сервис предоставляет механизм проверки токена сессии (`session_token`).
В ответ возвращается полная информация о сессии и пользователе, включая `user_id`, `session_id`, `expires_at` и данные профиля.

## Контракты (API)

Контракты определены в пакете `@axion/contracts` (`proto/auth/auth-service.proto`).

### Kafka / gRPC Messages

#### `ValidateSessionRequest`

Запрос на проверку токена.

| Поле            | Тип               | Описание                             |
| :-------------- | :---------------- | :----------------------------------- |
| `session_token` | `string`          | Токен сессии (Bearer token)          |
| `metadata`      | `RequestMetadata` | Метаданные запроса (trace_id и т.д.) |

#### `ValidateSessionResponse`

Ответ с результатом проверки.

| Поле      | Тип           | Описание                          |
| :-------- | :------------ | :-------------------------------- |
| `status`  | `Status`      | Статус операции (SUCCESS / ERROR) |
| `error`   | `Error`       | Детали ошибки (если есть)         |
| `session` | `SessionData` | Данные сессии (если успешно)      |

#### `SessionData`

| Поле         | Тип        | Описание                   |
| :----------- | :--------- | :------------------------- |
| `user_id`    | `string`   | ID пользователя            |
| `session_id` | `string`   | ID сессии                  |
| `expires_at` | `int64`    | Timestamp истечения сессии |
| `user`       | `UserData` | Данные пользователя        |

### HTTP Endpoints

- **POST** `/api/auth/validate-session`
  - Body: `ValidateSessionRequest` (JSON)
  - Response: `ValidateSessionResponse` (JSON)

- **Standard Better Auth Endpoints**
  - См. документацию [Better Auth](https://better-auth.com/docs/api) для полного списка (signIn, signUp, etc.).

## Зависимости

- **Database**: Требует подключения к PostgreSQL.
- **Kafka**: Опционально (если требуется валидация через Kafka), но рекомендуется для продакшена.
- **Packages**:
  - `@axion/contracts`: Типы и контракты.
  - `@axion/database`: Подключение к БД.
  - `better-auth`: Ядро аутентификации.

## Схема БД

Основные таблицы (генерируются Better Auth):

- `user`: Пользователи.
- `session`: Активные сессии.
- `account`: Привязанные аккаунты (OAuth).
- `verification`: Токены верификации.

## Конфигурация

Переменные окружения (`.env`):

| Переменная           | Описание                                    | Обязательно                              |
| :------------------- | :------------------------------------------ | :--------------------------------------- |
| `AUTH_DATABASE_URL`  | Строка подключения к PostgreSQL.            | Да                                       |
| `KAFKA_BROKERS`      | Адреса брокеров Kafka (через запятую).      | Нет (но нужно для продакшена)            |
| `BETTER_AUTH_SECRET` | Секретный ключ для подписи токенов.         | Нет (авто-генерируется, но лучше задать) |
| `BETTER_AUTH_URL`    | Базовый URL сервиса (для OAuth редиректов). | Нет                                      |
