---
title: "Secrets Management"
description: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞–º–∏ –∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏"
order: 16
---

# Secrets Management

Axion Stack –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–∞–º–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

## üìã –°—Ç—Ä–∞—Ç–µ–≥–∏—è Secrets Management

### –£—Ä–æ–≤–Ω–∏ —Å–µ–∫—Ä–µ—Ç–æ–≤

1. **Environment Variables** - –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
2. **Encrypted Storage** - –¥–ª—è —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
3. **External Secrets Manager** - –¥–ª—è production (AWS Secrets Manager, HashiCorp Vault)

## üîê Encryption at Rest

### SSH Encryption Service

–î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è SSH –∫–ª—é—á–µ–π –∏ –ø–∞—Ä–æ–ª–µ–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ:

```typescript
// packages/nestjs-common/src/ssh/services/ssh-encryption.service.ts
import { Injectable } from "@nestjs/common";
import { createCipheriv, createDecipheriv, randomBytes, scrypt } from "crypto";
import { promisify } from "util";

const scryptAsync = promisify(scrypt);

@Injectable()
export class SshEncryptionService {
  private readonly algorithm = "aes-256-gcm";
  private readonly keyLength = 32;
  private readonly ivLength = 16;
  private readonly saltLength = 16;
  private readonly tagLength = 16;

  /**
   * –®–∏—Ñ—Ä—É–µ—Ç —Å–µ–∫—Ä–µ—Ç —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º master key
   */
  async encryptSecret(plaintext: string, masterKey: string): Promise<string> {
    const salt = randomBytes(this.saltLength);
    const key = (await scryptAsync(masterKey, salt, this.keyLength)) as Buffer;
    const iv = randomBytes(this.ivLength);

    const cipher = createCipheriv(this.algorithm, key, iv);
    let encrypted = cipher.update(plaintext, "utf8", "hex");
    encrypted += cipher.final("hex");

    const authTag = cipher.getAuthTag();

    // –§–æ—Ä–º–∞—Ç: salt:iv:authTag:encrypted
    return `${salt.toString("hex")}:${iv.toString("hex")}:${authTag.toString("hex")}:${encrypted}`;
  }

  /**
   * –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç —Å–µ–∫—Ä–µ—Ç —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º master key
   */
  async decryptSecret(ciphertext: string, masterKey: string): Promise<string> {
    const parts = ciphertext.split(":");
    if (parts.length !== 4) {
      throw new Error("Invalid ciphertext format");
    }

    const [saltHex, ivHex, authTagHex, encrypted] = parts;
    const salt = Buffer.from(saltHex, "hex");
    const iv = Buffer.from(ivHex, "hex");
    const authTag = Buffer.from(authTagHex, "hex");

    const key = (await scryptAsync(masterKey, salt, this.keyLength)) as Buffer;

    const decipher = createDecipheriv(this.algorithm, key, iv);
    decipher.setAuthTag(authTag);

    let decrypted = decipher.update(encrypted, "hex", "utf8");
    decrypted += decipher.final("utf8");

    return decrypted;
  }

  /**
   * –†–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
   */
  async rotateSecret(
    oldCiphertext: string,
    oldMasterKey: string,
    newMasterKey: string
  ): Promise<string> {
    // –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–º –∫–ª—é—á–æ–º
    const plaintext = await this.decryptSecret(oldCiphertext, oldMasterKey);

    // –®–∏—Ñ—Ä—É–µ–º –Ω–æ–≤—ã–º –∫–ª—é—á–æ–º
    return this.encryptSecret(plaintext, newMasterKey);
  }
}
```

### Usage Example

```typescript
// apps/infrastructure-service/src/infrastructure/services/servers.service.ts
import { SshEncryptionService } from "@axion/nestjs-common";

@Injectable()
export class ServersService {
  constructor(
    private readonly sshEncryption: SshEncryptionService,
    private readonly serverRepository: ServerRepository
  ) {}

  async createServer(data: CreateServerRequest) {
    const masterKey = process.env.SSH_ENCRYPTION_MASTER_KEY;
    if (!masterKey) {
      throw new Error("SSH_ENCRYPTION_MASTER_KEY is required");
    }

    // –®–∏—Ñ—Ä—É–µ–º SSH –∫–ª—é—á –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
    const encryptedPrivateKey = data.privateKey
      ? await this.sshEncryption.encryptSecret(data.privateKey, masterKey)
      : null;

    const encryptedPassword = data.password
      ? await this.sshEncryption.encryptSecret(data.password, masterKey)
      : null;

    return this.serverRepository.create({
      ...data,
      encryptedPrivateKey,
      encryptedPassword,
    });
  }

  async getServer(id: string) {
    const server = await this.serverRepository.findById(id);
    if (!server) {
      return null;
    }

    const masterKey = process.env.SSH_ENCRYPTION_MASTER_KEY;
    if (!masterKey) {
      throw new Error("SSH_ENCRYPTION_MASTER_KEY is required");
    }

    // –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏
    const privateKey = server.encryptedPrivateKey
      ? await this.sshEncryption.decryptSecret(
          server.encryptedPrivateKey,
          masterKey
        )
      : null;

    const password = server.encryptedPassword
      ? await this.sshEncryption.decryptSecret(
          server.encryptedPassword,
          masterKey
        )
      : null;

    return {
      ...server,
      privateKey,
      password,
    };
  }
}
```

## üîÑ Key Rotation

### SSH Key Rotation Service

```typescript
// apps/infrastructure-service/src/infrastructure/services/ssh-key-rotation.service.ts
@Injectable()
export class SshKeyRotationService {
  constructor(
    private readonly sshEncryption: SshEncryptionService,
    private readonly serverRepository: ServerRepository
  ) {}

  async rotateKeys(oldMasterKey: string, newMasterKey: string) {
    const credentials =
      await this.serverRepository.listCredentialsForRotation();
    let rotated = 0;
    let failed = 0;

    for (const credential of credentials) {
      try {
        const rotatedPrivateKey = credential.encryptedPrivateKey
          ? await this.sshEncryption.rotateSecret(
              credential.encryptedPrivateKey,
              oldMasterKey,
              newMasterKey
            )
          : null;

        const rotatedPassword = credential.encryptedPassword
          ? await this.sshEncryption.rotateSecret(
              credential.encryptedPassword,
              oldMasterKey,
              newMasterKey
            )
          : null;

        await this.serverRepository.updateEncryptedCredentials(
          credential.id,
          rotatedPrivateKey,
          rotatedPassword
        );

        rotated += 1;
      } catch (error) {
        failed += 1;
        this.logger.error(
          `Failed to rotate credentials for server ${credential.id}`,
          error
        );
      }
    }

    return { rotated, failed };
  }
}
```

## üîß External Secrets Manager

### AWS Secrets Manager Integration

```typescript
// packages/shared/src/secrets/aws-secrets-manager.ts
import {
  SecretsManagerClient,
  GetSecretValueCommand,
} from "@aws-sdk/client-secrets-manager";

export class AwsSecretsManager {
  private client: SecretsManagerClient;

  constructor(region: string = "us-east-1") {
    this.client = new SecretsManagerClient({ region });
  }

  async getSecret(secretName: string): Promise<string> {
    const command = new GetSecretValueCommand({ SecretId: secretName });
    const response = await this.client.send(command);

    if (response.SecretString) {
      return response.SecretString;
    }

    if (response.SecretBinary) {
      return Buffer.from(response.SecretBinary).toString("utf-8");
    }

    throw new Error(`Secret ${secretName} is empty`);
  }

  async getSecretAsJson<T>(secretName: string): Promise<T> {
    const secret = await this.getSecret(secretName);
    return JSON.parse(secret) as T;
  }
}
```

### HashiCorp Vault Integration

```typescript
// packages/shared/src/secrets/vault.ts
import * as vault from "node-vault";

export class VaultSecretsManager {
  private client: vault.client;

  constructor(vaultAddr: string, vaultToken: string) {
    this.client = vault({
      endpoint: vaultAddr,
      token: vaultToken,
    });
  }

  async getSecret(path: string): Promise<Record<string, any>> {
    const result = await this.client.read(path);
    return result.data;
  }

  async getSecretValue(path: string, key: string): Promise<string> {
    const secret = await this.getSecret(path);
    return secret[key];
  }
}
```

### Secrets Service (Abstraction)

```typescript
// packages/shared/src/secrets/secrets.service.ts
export interface SecretsProvider {
  getSecret(name: string): Promise<string>;
  getSecretAsJson<T>(name: string): Promise<T>;
}

export class SecretsService {
  private provider: SecretsProvider;

  constructor(provider: SecretsProvider) {
    this.provider = provider;
  }

  async getSecret(name: string): Promise<string> {
    return this.provider.getSecret(name);
  }

  async getSecretAsJson<T>(name: string): Promise<T> {
    return this.provider.getSecretAsJson<T>(name);
  }

  // –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –ø–∞–º—è—Ç–∏ (—Å TTL)
  private cache = new Map<string, { value: any; expires: number }>();
  private ttl = 5 * 60 * 1000; // 5 minutes

  async getCachedSecret(name: string): Promise<string> {
    const cached = this.cache.get(name);
    if (cached && cached.expires > Date.now()) {
      return cached.value;
    }

    const value = await this.provider.getSecret(name);
    this.cache.set(name, {
      value,
      expires: Date.now() + this.ttl,
    });

    return value;
  }
}
```

## üö® Best Practices

1. **Never commit secrets to git**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `.env.example` —Å placeholder –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
   - –í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–π—Ç–µ `.env` –≤ `.gitignore`

2. **Use environment-specific secrets**
   - –†–∞–∑–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã –¥–ª—è dev, staging, production
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ external secrets manager –≤ production

3. **Rotate keys regularly**
   - –ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–≥—É–ª—è—Ä–Ω—É—é —Ä–æ—Ç–∞—Ü–∏—é master keys
   - –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å —Ä–æ—Ç–∞—Ü–∏–∏

4. **Limit access to secrets**
   - –ú–∏–Ω–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Ä–≤–∏—Å–æ–≤/–ª—é–¥–µ–π —Å –¥–æ—Å—Ç—É–ø–æ–º
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ IAM roles –∏ policies –¥–ª—è external secrets

5. **Monitor secret access**
   - –õ–æ–≥–∏—Ä—É–π—Ç–µ –¥–æ—Å—Ç—É–ø –∫ —Å–µ–∫—Ä–µ—Ç–∞–º
   - –ê–ª–µ—Ä—Ç –Ω–∞ –∞–Ω–æ–º–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø

## üîó –°–º. —Ç–∞–∫–∂–µ

- [Development Setup](./DEVELOPMENT_SETUP.md) - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [Infrastructure Service](../apps/infrastructure-service/README.md) - –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è SSH encryption
- [Environment Configuration](../templates/env/README.md) - —à–∞–±–ª–æ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
