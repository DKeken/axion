---
title: "Rate Limiting"
description: "–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —É—Ä–æ–≤–Ω–µ Traefik –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
order: 15
---

# Rate Limiting

Axion Stack –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é rate limiting –¥–ª—è –∑–∞—â–∏—Ç—ã API –∏ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã.

## üìã –°—Ç—Ä–∞—Ç–µ–≥–∏—è Rate Limiting

### –£—Ä–æ–≤–Ω–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **Traefik (Edge Level)** - –≥–ª–æ–±–∞–ª—å–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ reverse proxy
2. **Application Level** - —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–∏—Å–æ–≤
3. **User/Project Level** - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞

## üîß Traefik Rate Limiting

### Middleware Configuration

Traefik –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π middleware –¥–ª—è rate limiting:

```yaml
# docker/traefik/dynamic/middlewares.yml
http:
  middlewares:
    # –ì–ª–æ–±–∞–ª—å–Ω—ã–π rate limiter
    global-rate-limit:
      rateLimit:
        average: 100
        period: 1s
        burst: 50

    # Rate limiter –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    auth-rate-limit:
      rateLimit:
        average: 10
        period: 1m
        burst: 5

    # Rate limiter –¥–ª—è API endpoints
    api-rate-limit:
      rateLimit:
        average: 1000
        period: 1m
        burst: 200
        sourceCriterion:
          ipStrategy:
            depth: 1

    # Rate limiter –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç—Ä–µ–±—É–µ—Ç authentication)
    user-rate-limit:
      rateLimit:
        average: 500
        period: 1m
        burst: 100
        sourceCriterion:
          requestHeaderName: "X-User-ID"
```

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫ Router

```yaml
# docker/traefik/dynamic/routers.yml
http:
  routers:
    graph-service:
      rule: "Host(`api.axion.dev`) && PathPrefix(`/api/graph`)"
      service: graph-service
      middlewares:
        - global-rate-limit
        - api-rate-limit

    auth-service:
      rule: "Host(`api.axion.dev`) && PathPrefix(`/api/auth`)"
      service: auth-service
      middlewares:
        - auth-rate-limit
```

### Redis-based Rate Limiting (Advanced)

–î–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ rate limiting —Å Redis:

```yaml
# docker/traefik/dynamic/middlewares.yml
http:
  middlewares:
    redis-rate-limit:
      rateLimit:
        average: 1000
        period: 1m
        burst: 200
        # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Redis –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ rate limiting
        # –¢—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Traefik —Å Redis provider
```

## üéØ Application-Level Rate Limiting

### NestJS Rate Limiter

–ò—Å–ø–æ–ª—å–∑—É–µ–º `@nestjs/throttler` –¥–ª—è rate limiting –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:

```typescript
// packages/nestjs-common/src/rate-limit/setup-rate-limit.ts
import {
  ThrottlerModule,
  ThrottlerGuard,
  ThrottlerStorageRedis,
} from "@nestjs/throttler";
import { APP_GUARD } from "@nestjs/core";
import { Module } from "@nestjs/common";

export function setupRateLimit(options?: {
  ttl?: number;
  limit?: number;
  redisUrl?: string;
}) {
  const ttl = options?.ttl ?? 60; // seconds
  const limit = options?.limit ?? 100;
  const redisUrl = options?.redisUrl;

  const storage = redisUrl
    ? new ThrottlerStorageRedis({
        host: redisUrl,
        port: 6379,
      })
    : undefined; // In-memory storage (single instance)

  return {
    imports: [
      ThrottlerModule.forRoot({
        ttl,
        limit,
        storage,
      }),
    ],
    providers: [
      {
        provide: APP_GUARD,
        useClass: ThrottlerGuard,
      },
    ],
  };
}
```

### Controller-Level Rate Limiting

```typescript
// apps/graph-service/src/graph/graph.controller.ts
import { Controller, Get, UseGuards } from "@nestjs/common";
import { Throttle, ThrottlerGuard } from "@nestjs/throttler";

@Controller("graph")
@UseGuards(ThrottlerGuard)
export class GraphController {
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç: 100 requests per minute
  // –≠—Ç–æ—Ç endpoint: 10 requests per minute
  @Get("projects")
  @Throttle({ default: { limit: 10, ttl: 60000 } })
  async listProjects() {
    // ...
  }

  // –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π –ª–∏–º–∏—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–≤
  @Post("projects")
  @Throttle({ default: { limit: 5, ttl: 60000 } })
  async createProject() {
    // ...
  }
}
```

### User-Based Rate Limiting

```typescript
// packages/nestjs-common/src/rate-limit/user-rate-limit.guard.ts
import { Injectable, ExecutionContext, CanActivate } from "@nestjs/common";
import { ThrottlerGuard, ThrottlerException } from "@nestjs/throttler";
import { getUserIdFromMetadata } from "@axion/contracts";

@Injectable()
export class UserRateLimitGuard extends ThrottlerGuard {
  protected getTracker(req: Record<string, any>): string {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º user ID –≤–º–µ—Å—Ç–æ IP –¥–ª—è rate limiting
    const userId = getUserIdFromMetadata(req.axion?.metadata);
    return userId || super.getTracker(req);
  }
}
```

## üìä Rate Limiting Metrics

### Prometheus Metrics

```typescript
// packages/nestjs-common/src/rate-limit/rate-limit-metrics.ts
import { Counter, Gauge } from "prom-client";

export const rateLimitHits = new Counter({
  name: "rate_limit_hits_total",
  help: "Total number of rate limit hits",
  labelNames: ["endpoint", "user_id", "ip"],
});

export const rateLimitActive = new Gauge({
  name: "rate_limit_active_users",
  help: "Number of users currently being rate limited",
  labelNames: ["endpoint"],
});

export function recordRateLimitHit(
  endpoint: string,
  userId?: string,
  ip?: string
): void {
  rateLimitHits.inc({
    endpoint,
    user_id: userId || "anonymous",
    ip: ip || "unknown",
  });
}
```

## üîß Configuration

### Environment Variables

```env
# Global Rate Limiting
RATE_LIMIT_TTL_SECONDS=60
RATE_LIMIT_MAX_REQUESTS=100

# Redis for distributed rate limiting (optional)
REDIS_URL=redis://localhost:6379
RATE_LIMIT_USE_REDIS=true

# Per-endpoint rate limits (JSON)
RATE_LIMIT_ENDPOINTS={"POST /api/graph/projects": {"limit": 5, "ttl": 60000}}
```

### Traefik Configuration

```yaml
# docker/traefik/static/traefik.yml
entryPoints:
  web:
    address: ":80"
    # Rate limiting –Ω–∞ —É—Ä–æ–≤–Ω–µ entry point
    transport:
      respondingTimeouts:
        readTimeout: 30s
        writeTimeout: 30s
```

## üö® Best Practices

1. **–†–∞–∑–Ω—ã–µ –ª–∏–º–∏—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö endpoints**
   - –°—Ç—Ä–æ–≥–∏–µ –ª–∏–º–∏—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
   - –ë–æ–ª–µ–µ –º—è–≥–∫–∏–µ –ª–∏–º–∏—Ç—ã –¥–ª—è —á—Ç–µ–Ω–∏—è

2. **User-based vs IP-based**
   - –î–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ–º user-based
   - –î–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö endpoints –∏—Å–ø–æ–ª—å–∑—É–µ–º IP-based

3. **Graceful degradation**
   - –í–æ–∑–≤—Ä–∞—â–∞–µ–º HTTP 429 —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ `Retry-After`
   - –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (health checks)

4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º rate limit hits
   - –ê–ª–µ—Ä—Ç–∏–º –ø—Ä–∏ –∞–Ω–æ–º–∞–ª—å–Ω–æ–º —Ä–æ—Å—Ç–µ

## üîó –°–º. —Ç–∞–∫–∂–µ

- [API Reference](./API_REFERENCE.mdx) - HTTP API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [Architecture](./ARCHITECTURE.mdx) - –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã
- [Traefik Configuration](../docker/traefik/README.md) - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Traefik
