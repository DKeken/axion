---
title: "Component: Database Connection (ORM Abstraction)"
description: "Абстракция для подключения к базе данных. Текущая реализация: Drizzle ORM."
order: 0
---

# Component: Database Connection (ORM Abstraction)

## Описание

Абстракция для подключения к базе данных. **Текущая реализация:** Drizzle ORM.  
Архитектура позволяет легко добавлять новые ORM.

**Используется в:** всех сервисах с базой данных

<Callout type="info" title="Связанные документы">
  - **Текущая реализация:** [Drizzle Connection](../../drizzle/connection.ts) -
  **Database Nodes:** См. [DATABASE_NODES](../../DATABASE_NODES) для работы с
  database nodes - **Расширяемость:** См. [EXTENSIBILITY](../../EXTENSIBILITY)
  для добавления новых ORM
</Callout>

## Конфигурация

- `{CONNECTION_NAME}` - имя подключения (из database node)
- `{ORM}` - тип ORM (сейчас только `drizzle`, но архитектура расширяема)

## Код

```typescript
// src/database/connection.ts
import { ORMType } from "../types";
import { drizzle } from "drizzle-orm/postgres-js";
import postgres from "postgres";
import { sql } from "drizzle-orm";

export class DatabaseConnection {
  private connection: unknown; // ORM client (Drizzle сейчас, но может быть любой)
  private postgresConnection?: ReturnType<typeof postgres>; // Для Drizzle
  private connectionName: string;
  private orm: ORMType;

  constructor(connectionName: string, orm: ORMType) {
    this.connectionName = connectionName;
    this.orm = orm;

    const databaseUrl =
      process.env[`DATABASE_URL_${connectionName.toUpperCase()}`] ||
      process.env.DATABASE_URL ||
      "";

    if (!databaseUrl) {
      throw new Error(
        `Database URL not found for connection: ${connectionName}`
      );
    }

    // Создаем подключение в зависимости от ORM
    // Текущая реализация: только Drizzle
    // Для добавления новых ORM см. EXTENSIBILITY.md
    if (orm === ORMType.DRIZZLE) {
      // Для Drizzle нужно хранить postgres connection отдельно
      this.postgresConnection = postgres(databaseUrl, {
        max: 10,
        idle_timeout: 20,
        connect_timeout: 10,
      });
      this.connection = drizzle(this.postgresConnection);
    } else {
      throw new Error(
        `Unsupported ORM: ${orm}. See EXTENSIBILITY.md to add new ORM support.`
      );
    }
  }

  async connect(): Promise<void> {
    // Drizzle подключается автоматически при создании
    // Но можно добавить явную проверку
    await this.healthCheck();
  }

  async disconnect(): Promise<void> {
    if (this.orm === ORMType.DRIZZLE) {
      // Закрываем postgres connection напрямую
      if (this.postgresConnection) {
        await this.postgresConnection.end();
        this.postgresConnection = undefined;
      }
    }
    // Для других ORM добавь логику здесь (см. [`EXTENSIBILITY`](../../../EXTENSIBILITY))
  }

  getClient(): unknown {
    return this.connection;
  }

  async healthCheck(): Promise<{ status: string; error?: string }> {
    try {
      if (this.orm === ORMType.DRIZZLE) {
        const db = this.connection as ReturnType<typeof drizzle>;
        await db.execute(sql`SELECT 1`);
      }
      // Для других ORM добавь логику здесь (см. [`EXTENSIBILITY`](../../../EXTENSIBILITY))
      return { status: "healthy" };
    } catch (error) {
      return {
        status: "unhealthy",
        error: error instanceof Error ? error.message : String(error),
      };
    }
  }

  getORM(): ORMType {
    return this.orm;
  }

  getConnectionName(): string {
    return this.connectionName;
  }
}
```

## LLM Инструкции

**LLM НЕ генерит этот файл** - он создается автоматически из шаблона.

## Checklist

- [ ] ORM определен из database node
- [ ] Connection name корректный
- [ ] Database URL настроен
- [ ] Health check работает
- [ ] Disconnect работает корректно
- [ ] Типы корректны
