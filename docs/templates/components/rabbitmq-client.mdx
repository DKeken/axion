---
title: "Component: RabbitMQ Client"
description: "Клиент для отправки сообщений другим сервисам через RabbitMQ."
order: 5
---

# Component: RabbitMQ Client

## Описание

Клиент для отправки сообщений другим сервисам через RabbitMQ.

**Используется в:** всех сервисах которые вызывают другие сервисы

## Конфигурация

- `{VHOST}` - виртуальный хост RabbitMQ
- `{TIMEOUT}` - таймаут ожидания ответа (по умолчанию 30000ms)

## Код

```typescript
// src/messaging/client.ts
import amqp from "amqplib";

export class RabbitMQClient {
  private connection: amqp.Connection | null = null;
  private channel: amqp.Channel | null = null;

  constructor(
    private url: string,
    private vhost: string
  ) {}

  async connect() {
    if (!this.connection) {
      this.connection = await amqp.connect(`${this.url}/${this.vhost}`);
      this.channel = await this.connection.createChannel();
    }
  }

  async call<T>(
    pattern: string,
    data: any,
    timeout: number = 30000
  ): Promise<T> {
    if (!this.channel) {
      await this.connect();
    }

    const queue = `axion.${pattern}`;
    const replyQueue = `axion.${pattern}.reply.${Date.now()}`;

    await this.channel!.assertQueue(queue, { durable: true });
    await this.channel!.assertQueue(replyQueue, { exclusive: true });

    const correlationId = Date.now().toString();

    return new Promise((resolve, reject) => {
      const timeoutId = setTimeout(() => {
        reject(new Error(`Timeout waiting for response from ${pattern}`));
      }, timeout);

      this.channel!.consume(
        replyQueue,
        (msg) => {
          if (msg?.properties.correlationId === correlationId) {
            clearTimeout(timeoutId);

            const result = JSON.parse(msg.content.toString());

            if (result.error) {
              reject(new Error(result.message));
            } else {
              resolve(result);
            }
          }
        },
        { noAck: true }
      );

      this.channel!.sendToQueue(queue, Buffer.from(JSON.stringify(data)), {
        correlationId,
        replyTo: replyQueue,
      });
    });
  }

  async close() {
    if (this.channel) {
      await this.channel.close();
    }
    if (this.connection) {
      await this.connection.close();
    }
  }
}
```

## LLM Инструкции

**LLM НЕ генерит этот файл** - он создается автоматически из шаблона.

## Checklist

- [ ] Подключение к RabbitMQ работает
- [ ] Вызовы других сервисов работают
- [ ] Таймауты обрабатываются
- [ ] Ошибки обрабатываются
- [ ] Graceful shutdown реализован
