---
title: "Resilience Patterns"
description: "Паттерны отказоустойчивости для всех сервисов. Обеспечивают стабильность при сбоях."
order: 1
---

# Resilience Patterns

## Обзор

Паттерны отказоустойчивости для всех сервисов. Обеспечивают стабильность при сбоях.

<Callout type="warn" title="Важно">
  Все сервисы должны реализовывать паттерны отказоустойчивости для обеспечения
  стабильности при сбоях.
</Callout>

## Retry Patterns

**Exponential Backoff:** Повторные попытки с увеличивающейся задержкой.

| Параметр         | Значение по умолчанию | Описание                              |
| ---------------- | --------------------- | ------------------------------------- |
| **maxRetries**   | 3                     | Максимальное количество попыток       |
| **initialDelay** | 1000ms                | Начальная задержка                    |
| **factor**       | 2                     | Множитель для экспоненциального роста |

| Использование          | Описание                         |
| ---------------------- | -------------------------------- |
| **Database queries**   | Автоматический retry для Drizzle |
| **HTTP RPC calls**     | Retry для отправки запросов      |
| **External API calls** | Retry для внешних сервисов       |

## Circuit Breaker

Защита от каскадных сбоев.

| Состояние     | Условие перехода   | Действие            |
| ------------- | ------------------ | ------------------- |
| **CLOSED**    | Нормальная работа  | Запросы проходят    |
| **OPEN**      | threshold=5 ошибок | Запросы блокируются |
| **HALF_OPEN** | timeout=60s        | Тестовые запросы    |

**Использование:** Для внешних зависимостей (API, БД, HTTP RPC).

## Timeout

Ограничение времени выполнения операций.

| Компонент          | Timeout по умолчанию | Настройка           |
| ------------------ | -------------------- | ------------------- |
| **Traefik (edge)** | 5 секунд             | Настраивается       |
| **Сервисы**        | Настраивается        | Для каждого сервиса |

**Использование:** Все асинхронные операции должны иметь timeout.

## Fallback

Альтернативная стратегия при сбое основной операции.

| Сценарий                   | Fallback стратегия               |
| -------------------------- | -------------------------------- |
| **БД недоступна**          | Использовать кеш (Redis)         |
| **Внешний API недоступен** | Использовать кешированные данные |
| **HTTP RPC недоступен**    | Локальная очередь                |

## Bulkhead

Изоляция ресурсов для предотвращения каскадных сбоев.

| Параметр          | Значение по умолчанию | Описание                                       |
| ----------------- | --------------------- | ---------------------------------------------- |
| **maxConcurrent** | 10                    | Максимальное количество одновременных запросов |

## Graceful Shutdown

Корректное завершение работы.

| Действие                          | Описание                              |
| --------------------------------- | ------------------------------------- |
| **Закрытие соединений**           | БД, HTTP connections, Redis           |
| **Завершение обработки запросов** | Дождаться завершения текущих запросов |
| **Timeout для handlers**          | Ограничение времени ожидания          |

**Реализация:** Обработка SIGTERM/SIGINT, регистрация shutdown handlers.

## Health Check с Degradation

Health check показывает деградацию:

| Статус        | Описание                   | Действие                      |
| ------------- | -------------------------- | ----------------------------- |
| **HEALTHY**   | Все зависимости работают   | Нормальная работа             |
| **DEGRADED**  | Частичная функциональность | Ограниченная функциональность |
| **UNHEALTHY** | Все зависимости недоступны | Сервис недоступен             |

## Monitoring & Alerting

Метрики для отслеживания:

| Метрика                                 | Описание               | Тип     |
| --------------------------------------- | ---------------------- | ------- |
| `resilience_retry_total`                | Количество retry       | Counter |
| `resilience_circuit_breaker_open_total` | Circuit breaker открыт | Counter |
| `resilience_timeout_total`              | Timeout                | Counter |
| `resilience_fallback_total`             | Использование fallback | Counter |

## Checklist

- [ ] Retry механизмы реализованы
- [ ] Circuit breaker настроен для внешних зависимостей
- [ ] Timeout установлен для всех асинхронных операций
- [ ] Fallback стратегии определены
- [ ] Graceful shutdown реализован
- [ ] Health checks показывают деградацию
- [ ] Метрики собираются
- [ ] Логирование ошибок настроено

---

_Паттерны отказоустойчивости для стабильности сервисов._
