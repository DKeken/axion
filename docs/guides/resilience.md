---
title: "Паттерны Отказоустойчивости"
description: "Конфигурация и реализация паттернов отказоустойчивости (Resilience) в сервисах Axion."
---

# Паттерны Отказоустойчивости (Resilience Patterns)

Все сервисы в экосистеме Axion должны реализовывать стандартизированные паттерны отказоустойчивости. Это обеспечивает стабильность системы при частичных сбоях (сеть, БД, внешние API).

## 1. Retry Configuration (Повторные попытки)

Мы используем стратегию **Exponential Backoff** для обработки временных сбоев (Transient Failures).

| Параметр         | Значение по умолчанию | Описание                                            |
| :--------------- | :-------------------- | :-------------------------------------------------- |
| **maxRetries**   | 3                     | Максимальное количество попыток повтора.            |
| **initialDelay** | 1000ms                | Начальная задержка перед первым повтором.           |
| **factor**       | 2                     | Множитель экспоненциального роста (1s -> 2s -> 4s). |

**Реализация:**

- **Database**: Drizzle ORM настроен на автоматический повтор при ошибках соединения или дедлоках.
- **HTTP RPC**: Встроенный клиент автоматически повторяет идемпотентные запросы (GET, PUT) при сетевых ошибках.
- **External API**: Обязательно для вызовов внешних сервисов (OpenRouter, Stripe).

## 2. Circuit Breaker (Предохранитель)

Защищает систему от каскадных сбоев, когда зависимый сервис полностью недоступен. Предотвращает бесполезную нагрузку на упавший сервис.

| Состояние     | Условие перехода  | Действие системы                                     |
| :------------ | :---------------- | :--------------------------------------------------- |
| **CLOSED**    | Нормальная работа | Запросы проходят штатно.                             |
| **OPEN**      | 5 ошибок подряд   | Запросы блокируются мгновенно (Fail Fast).           |
| **HALF_OPEN** | Тайм-аут 60 сек   | Пробный запрос. Если успех -> CLOSED, иначе -> OPEN. |

**Область применения:**
Применяется ко всем внешним зависимостям (OpenRouter, Stripe, AWS) и критическим внутренним вызовам между сервисами.

## 3. Timeouts (Тайм-ауты)

Строгие ограничения времени выполнения предотвращают зависание потоков и истощение ресурсов.

- **Traefik (Edge)**: 5 секунд (настраивается для долгих запросов). Обрывает соединение с клиентом.
- **Service RPC**: 5 секунд по умолчанию.
- **Database**: 2 секунды на выполнение SQL запроса (`statement_timeout`).

## 4. Bulkhead (Отсеки)

Изоляция ресурсов для предотвращения влияния сбоя одной части системы на другие.

- **Max Concurrent Requests**: Ограничение в 10 одновременных запросов на один handler instance для тяжелых операций.
- **Kafka Consumers**: Регулируется через переменную `KAFKA_MAX_CONCURRENT_HANDLERS`. Позволяет не забить память при всплеске сообщений.

## 5. Graceful Shutdown (Корректное завершение)

Каждый сервис обязан корректно обрабатывать сигналы `SIGTERM` и `SIGINT` (например, при редеплое):

1.  **Остановка приема трафика**: Перестать принимать новые HTTP/RPC запросы.
2.  **Пауза Kafka**: Остановить потребление новых сообщений из топиков.
3.  **Draining**: Дать 30 секунд (настраивается) на завершение текущих активных запросов.
4.  **Cleanup**: Закрыть соединения с БД, Redis и другими ресурсами.

## 6. Health Checks (Проверка здоровья)

Сервисы должны предоставлять детальный health endpoint, отражающий состояние зависимостей:

- **HEALTHY**: Все системы работают (БД, Кеш, Kafka).
- **DEGRADED**: Не работает некритичная зависимость (например, Redis упал, но БД работает — сервис может работать медленнее).
- **UNHEALTHY**: Критическая зависимость недоступна (БД) — трафик переключается на другие инстансы.

## Метрики для мониторинга

Реализация должна экспортировать следующие Prometheus метрики для визуализации проблем:

- `resilience_retry_total` (Counter): Количество срабатываний Retry.
- `resilience_circuit_breaker_open_total` (Counter): Сколько раз открывался Circuit Breaker.
- `resilience_timeout_total` (Counter): Количество обрывов по тайм-ауту.
- `resilience_fallback_total` (Counter): Использование запасных вариантов (fallback).
