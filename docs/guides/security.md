---
title: "Безопасность и Rate Limiting"
description: "Руководство по управлению секретами, шифрованию данных и защите API от перегрузок в Axion."
---

# Безопасность и Rate Limiting

Этот раздел объединяет две критически важные области архитектуры Axion: безопасное управление секретами пользователей и защита платформы от DDoS и злоупотреблений.

## 1. Управление секретами (Secrets Management)

Безопасность пользовательских данных — наш приоритет. Мы используем многоуровневый подход к защите чувствительной информации (SSH-ключи, пароли БД, API токены).

### Шифрование данных (Encryption at Rest)

Чувствительные данные **никогда** не хранятся в открытом виде. Мы используем **SSH Encryption Service** со следующей спецификацией:

- **Алгоритм**: AES-256-GCM (Authenticated Encryption).
- **Генерация ключа (Key Derivation)**: Scrypt KDF генерирует ключ шифрования на основе Master Key (из env) и уникальной соли.
- **Формат хранения**: `salt:iv:authTag:encryptedPayload`.
- **Целостность**: Auth Tag гарантирует, что данные не были подменены или повреждены.

### Ротация ключей (Key Rotation)

Система поддерживает бесшовную ротацию Master Key. Infrastructure Service может перешифровать все секреты в базе: расшифровать старым ключом и зашифровать новым, не прерывая работу сервиса.

### Среды хранения

- **Development**: Секреты хранятся в `.env` файлах (добавлены в `.gitignore`).
- **Production**: Рекомендуется использование внешних менеджеров секретов (AWS Secrets Manager, HashiCorp Vault).

```typescript
// Пример интеграции с Vault
const vault = new VaultSecretsManager(
  process.env.VAULT_ADDR,
  process.env.VAULT_TOKEN
);
const dbPassword = await vault.getSecretValue("secret/data/db", "password");
```

### Правила безопасности

1.  **Никаких секретов в Git**: Строго контролируется через линтеры и pre-commit хуки.
2.  **Минимальные привилегии (Least Privilege)**: Доступ к Master Key имеют только сервисы, работающие с секретами напрямую (например, `InfrastructureService`).
3.  **Аудит доступа**: Любая операция чтения зашифрованного секрета логируется (сам секрет в логи не попадает).

---

## 2. Ограничение нагрузки (Rate Limiting)

Для обеспечения стабильности системы и защиты от атак, Axion реализует эшелонированную защиту на нескольких уровнях.

### Уровень Edge (Traefik)

Traefik выступает первой линией обороны:
- **Global Rate Limit**: Базовое ограничение на весь входящий трафик для защиты от DDoS.
- **Auth Rate Limit**: Строгие лимиты на эндпоинты авторизации (например, 10 запросов/мин) для предотвращения Brute-force атак.
- **IP-Based Limits**: Применяются к публичным API.

### Уровень Приложения (NestJS)

Внутри микросервисов используется `@nestjs/throttler` для более тонкой настройки бизнес-логики:
- **Controller/Endpoint Limits**: Специфические лимиты для "тяжелых" операций (генерация кода, создание проекта).

```typescript
// Пример: 5 запросов в минуту на создание проекта
@Throttle({ default: { limit: 5, ttl: 60000 } })
@Post("projects")
async createProject() { ... }
```

### Пользовательские лимиты (User-Based)

Используя `UserRateLimitGuard`, мы применяем лимиты на основе `userId` из метаданных запроса. Это обеспечивает честное распределение ресурсов (Fair Usage) независимо от того, с каких IP адресов заходит пользователь.

### Мониторинг и Best Practices

- **Метрики**: `rate_limit_hits_total` экспортируется в Prometheus для отслеживания атак.
- **Retry-After**: При ответе 429 (Too Many Requests) всегда возвращается заголовок `Retry-After`, указывающий клиенту время ожидания.
- **Исключения**: Внутренние вызовы между сервисами и Health Checks не подвергаются ограничению.
