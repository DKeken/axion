---
title: "Kafka Guide"
description: "Архитектура шины событий, стандарты сообщений и обработка ошибок в Axion."
---

# Kafka в Axion

Kafka выступает в роли центральной нервной системы (Event Bus) для Control Plane. Она обеспечивает асинхронное взаимодействие микросервисов, гарантию доставки команд и развязывание компонентов (Decoupling).

## Архитектура коммуникации

1.  **Synchronous (HTTP)**: Клиент -> Gateway -> Сервис. Используется для чтения данных (GET) и операций, требующих мгновенного ответа.
2.  **Asynchronous (Kafka)**: Сервис -> Kafka -> Сервис. Используется для всех операций изменения состояния (Commands) и уведомлений (Events).

## Стандарты сообщений

Каждое сообщение в Kafka должно содержать метаданные для обеспечения наблюдаемости (Observability). Мы используем Headers для передачи контекста.

### Обязательные заголовки

| Header | Описание |
| :--- | :--- |
| `x-correlation-id` | UUID цепочки вызовов (Trace ID). |
| `x-causation-id` | ID сообщения, вызвавшего текущее событие. |
| `x-user-id` | ID пользователя-инициатора. |
| `x-project-id` | ID проекта (для изоляции контекста). |
| `x-timestamp` | Время создания события (Unix ms). |

```typescript
// Пример отправки сообщения через Codegen Client
await this.client.emit('project.generate', {
  id: projectId,
  blueprint: 'crud-service',
}, {
  metadata: { userId, traceId } // Автоматически маппится в headers
});
```

## Обработка ошибок (Reliability)

### 1. Retry Policy (Повторы)
Для временных сбоев (сеть, недоступность БД) применяется стратегия экспоненциального отката.
*   **Attempts**: 3
*   **Backoff**: `100ms * 2^attempt`

### 2. Dead Letter Queue (DLQ)
Если сообщение не удалось обработать после всех попыток (например, баг в коде или невалидные данные), оно отправляется в DLQ.
*   **Топик**: `{service}-dlq`
*   **Мониторинг**: DLQ должен быть пустым. Наличие сообщений — инцидент.

## Consumer Groups
Все сервисы работают в рамках Consumer Groups (`{service-group}`).
*   **Масштабирование**: Kafka автоматически распределяет партиции топика между инстансами сервиса.
*   **Отказоустойчивость**: При падении инстанса его партиции передаются другому живому инстансу.

## Идемпотентность
Так как Kafka гарантирует доставку "at-least-once" (как минимум один раз), возможны дубликаты.
*   **Решение**: `KafkaIdempotencyInterceptor` вычисляет хеш сообщения (`topic + partition + offset`) и игнорирует уже обработанные события.

## Контроль нагрузки (Backpressure)
Для защиты сервисов от перегрузки при всплеске трафика (Traffic Spikes) используется ограничение параллелизма.
*   **Параметр**: `KAFKA_MAX_CONCURRENT_HANDLERS` (по умолчанию 10).
*   **Механизм**: Сервис не берет новые сообщения из Kafka, пока не освободится слот в пуле обработчиков.
