syntax = "proto3";

package axion.graph.v1;

import "buf/validate/validate.proto";
import "google/protobuf/timestamp.proto";

enum NodeType {
  NODE_TYPE_UNSPECIFIED = 0;
  NODE_TYPE_SERVICE = 1;
  NODE_TYPE_DATABASE = 2;
  NODE_TYPE_QUEUE = 3;
  NODE_TYPE_CACHE = 4;
  NODE_TYPE_INGRESS = 5;
  NODE_TYPE_LOGIC = 6;
}

enum EdgeType {
  EDGE_TYPE_UNSPECIFIED = 0;
  EDGE_TYPE_HTTP = 1;
  EDGE_TYPE_GRPC = 2;
  EDGE_TYPE_KAFKA = 3;
  EDGE_TYPE_DATABASE = 4;
}

enum ServiceStatus {
  SERVICE_STATUS_UNSPECIFIED = 0;
  SERVICE_STATUS_PENDING = 1;
  SERVICE_STATUS_RUNNING = 2;
  SERVICE_STATUS_STOPPED = 3;
  SERVICE_STATUS_ERROR = 4;
}

message Position {
  double x = 1;
  double y = 2;
}

message NodeData {
  string label = 1 [(buf.validate.field).string.min_len = 1];
  string blueprint_id = 2;
  map<string, string> config = 3;
}

message Node {
  string id = 1 [(buf.validate.field).string.uuid = true];
  NodeType type = 2;
  NodeData data = 3 [(buf.validate.field).required = true];
  Position position = 4;
}

message Edge {
  string id = 1 [(buf.validate.field).string.uuid = true];
  string source = 2 [(buf.validate.field).string.uuid = true];
  string target = 3 [(buf.validate.field).string.uuid = true];
  EdgeType type = 4;
  map<string, string> config = 5;
}

message GraphData {
  repeated Node nodes = 1;
  repeated Edge edges = 2;
  
  option (buf.validate.message).cel = {
    id: "graph_not_empty"
    message: "graph must contain at least one node"
    expression: "this.nodes.size() > 0"
  };
}

message ProjectService {
  string id = 1 [(buf.validate.field).string.uuid = true];
  string project_id = 2 [(buf.validate.field).string.uuid = true];
  string node_id = 3;
  string service_name = 4;
  string blueprint_id = 5;
  map<string, string> config = 6;
  ServiceStatus status = 7;
  int32 code_version = 8;
  string generated_code_path = 9;
  google.protobuf.Timestamp created_at = 10;
  google.protobuf.Timestamp updated_at = 11;
}

message GraphVersion {
  string id = 1 [(buf.validate.field).string.uuid = true];
  string project_id = 2 [(buf.validate.field).string.uuid = true];
  int32 version = 3;
  GraphData graph_data = 4;
  google.protobuf.Timestamp created_at = 5;
}
