# Static Traefik configuration (альтернатива автогенерации)
# Используйте этот файл если не хотите генерировать конфигурацию динамически
#
# Чтобы использовать:
# 1. Переименуйте этот файл в routers.yml
# 2. Или скопируйте: cp routers.static.yml routers.yml
#
# Для автогенерации используйте: bun run docker:generate-traefik-config

http:
  routers:
    # Traefik Dashboard
    traefik:
      rule: "Host(`traefik.localhost`)"
      entryPoints: ["web"]
      service: api@internal

    # Graph Service
    graph:
      rule: "PathPrefix(`/api/v1/graph`)"
      entryPoints: ["web"]
      service: graph-service
      middlewares:
        - graph-stripprefix

    graph-secure:
      rule: "PathPrefix(`/api/v1/graph`)"
      entryPoints: ["websecure"]
      service: graph-service
      middlewares:
        - graph-stripprefix

    graph-ws:
      rule: "PathPrefix(`/api/v1/graph`)"
      entryPoints: ["web"]
      service: graph-service
      middlewares:
        - graph-stripprefix
        - graph-ws-headers

    # Codegen Service
    codegen:
      rule: "PathPrefix(`/api/v1/codegen`)"
      entryPoints: ["web"]
      service: codegen-service
      middlewares:
        - codegen-stripprefix

    codegen-secure:
      rule: "PathPrefix(`/api/v1/codegen`)"
      entryPoints: ["websecure"]
      service: codegen-service
      middlewares:
        - codegen-stripprefix

    # Deployment Service
    deployment:
      rule: "PathPrefix(`/api/v1/deployment`)"
      entryPoints: ["web"]
      service: deployment-service
      middlewares:
        - deployment-stripprefix

    deployment-secure:
      rule: "PathPrefix(`/api/v1/deployment`)"
      entryPoints: ["websecure"]
      service: deployment-service
      middlewares:
        - deployment-stripprefix

    # Infrastructure Service
    infrastructure:
      rule: "PathPrefix(`/api/v1/infrastructure`)"
      entryPoints: ["web"]
      service: infrastructure-service
      middlewares:
        - infrastructure-stripprefix

    infrastructure-secure:
      rule: "PathPrefix(`/api/v1/infrastructure`)"
      entryPoints: ["websecure"]
      service: infrastructure-service
      middlewares:
        - infrastructure-stripprefix

    # Billing Service
    billing:
      rule: "PathPrefix(`/api/v1/billing`)"
      entryPoints: ["web"]
      service: billing-service
      middlewares:
        - billing-stripprefix

    billing-secure:
      rule: "PathPrefix(`/api/v1/billing`)"
      entryPoints: ["websecure"]
      service: billing-service
      middlewares:
        - billing-stripprefix

  services:
    # Graph Service
    graph-service:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:3001"

    # Codegen Service
    codegen-service:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:3002"

    # Deployment Service
    deployment-service:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:3005"

    # Infrastructure Service
    infrastructure-service:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:3004"

    # Billing Service
    billing-service:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:3006"

  middlewares:
    # Strip prefix middlewares
    graph-stripprefix:
      stripPrefix:
        prefixes:
          - "/api/v1/graph"

    codegen-stripprefix:
      stripPrefix:
        prefixes:
          - "/api/v1/codegen"

    deployment-stripprefix:
      stripPrefix:
        prefixes:
          - "/api/v1/deployment"

    infrastructure-stripprefix:
      stripPrefix:
        prefixes:
          - "/api/v1/infrastructure"

    billing-stripprefix:
      stripPrefix:
        prefixes:
          - "/api/v1/billing"

    # WebSocket headers
    graph-ws-headers:
      headers:
        customRequestHeaders:
          Upgrade: "websocket"
