# Static Traefik configuration (альтернатива автогенерации)
# Используйте этот файл если не хотите генерировать конфигурацию динамически
#
# Чтобы использовать:
# 1. Переименуйте этот файл в routers.yml
# 2. Или скопируйте: cp routers.static.yml routers.yml
#
# Для автогенерации используйте: bun run docker:generate-traefik-config

http:
  routers:
    # Traefik Dashboard
    traefik:
      rule: "Host(`traefik.localhost`)"
      entryPoints: ["web"]
      service: api@internal

    # Graph Service
    graph:
      rule: "PathPrefix(`/api/v1/graph`)"
      entryPoints: ["web"]
      service: graph-service
      middlewares:
        - cors
        - graph-stripprefix

    graph-secure:
      rule: "PathPrefix(`/api/v1/graph`)"
      entryPoints: ["websecure"]
      service: graph-service
      middlewares:
        - cors
        - graph-stripprefix

    graph-ws:
      rule: "PathPrefix(`/api/v1/graph`)"
      entryPoints: ["web"]
      service: graph-service
      middlewares:
        - cors
        - graph-stripprefix
        - graph-ws-headers

    # Codegen Service
    codegen:
      rule: "PathPrefix(`/api/v1/codegen`)"
      entryPoints: ["web"]
      service: codegen-service
      middlewares:
        - cors
        - codegen-stripprefix

    codegen-secure:
      rule: "PathPrefix(`/api/v1/codegen`)"
      entryPoints: ["websecure"]
      service: codegen-service
      middlewares:
        - cors
        - codegen-stripprefix

    # Deployment Service
    deployment:
      rule: "PathPrefix(`/api/v1/deployment`)"
      entryPoints: ["web"]
      service: deployment-service
      middlewares:
        - cors
        - deployment-stripprefix

    deployment-secure:
      rule: "PathPrefix(`/api/v1/deployment`)"
      entryPoints: ["websecure"]
      service: deployment-service
      middlewares:
        - cors
        - deployment-stripprefix

    # Infrastructure Service
    infrastructure:
      rule: "PathPrefix(`/api/v1/infrastructure`)"
      entryPoints: ["web"]
      service: infrastructure-service
      middlewares:
        - cors
        - infrastructure-stripprefix

    infrastructure-secure:
      rule: "PathPrefix(`/api/v1/infrastructure`)"
      entryPoints: ["websecure"]
      service: infrastructure-service
      middlewares:
        - cors
        - infrastructure-stripprefix

    # Billing Service
    billing:
      rule: "PathPrefix(`/api/v1/billing`)"
      entryPoints: ["web"]
      service: billing-service
      middlewares:
        - cors
        - billing-stripprefix

    billing-secure:
      rule: "PathPrefix(`/api/v1/billing`)"
      entryPoints: ["websecure"]
      service: billing-service
      middlewares:
        - cors
        - billing-stripprefix

  services:
    # Graph Service
    graph-service:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:3001"

    # Codegen Service
    codegen-service:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:3002"

    # Deployment Service
    deployment-service:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:3005"

    # Infrastructure Service
    infrastructure-service:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:3004"

    # Billing Service
    billing-service:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:3006"

  middlewares:
    cors:
      headers:
        accessControlAllowCredentials: true
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        accessControlAllowHeaders:
          - Authorization
          - Content-Type
          - Accept
          - X-Requested-With
          - X-Correlation-ID
        accessControlExposeHeaders:
          - X-Correlation-ID
        accessControlMaxAge: 86400
        addVaryHeader: true
        accessControlAllowOriginList:
          - "http://localhost:3000"
          - "http://localhost:3001"
          - "http://127.0.0.1:3000"
          - "http://127.0.0.1:3001"
          - "http://traefik.localhost"
          - "https://traefik.localhost"
        # "*" is not allowed with credentials, so use regex list (dev defaults)
        accessControlAllowOriginListRegex:
          - "^https?://localhost(?::\\d+)?$"
          - "^https?://127\\.0\\.0\\.1(?::\\d+)?$"
          - "^https?://traefik\\.localhost(?::\\d+)?$"
          - "^https?://192\\.168\\.\\d+\\.\\d+(?::\\d+)?$"
          - "^https?://10\\.\\d+\\.\\d+\\.\\d+(?::\\d+)?$"
          - "^https?://172\\.(1[6-9]|2\\d|3[0-1])\\.\\d+\\.\\d+(?::\\d+)?$"

    # Strip prefix middlewares
    graph-stripprefix:
      stripPrefix:
        prefixes:
          - "/api/v1/graph"

    codegen-stripprefix:
      stripPrefix:
        prefixes:
          - "/api/v1/codegen"

    deployment-stripprefix:
      stripPrefix:
        prefixes:
          - "/api/v1/deployment"

    infrastructure-stripprefix:
      stripPrefix:
        prefixes:
          - "/api/v1/infrastructure"

    billing-stripprefix:
      stripPrefix:
        prefixes:
          - "/api/v1/billing"

    # WebSocket headers
    graph-ws-headers:
      headers:
        customRequestHeaders:
          Upgrade: "websocket"
